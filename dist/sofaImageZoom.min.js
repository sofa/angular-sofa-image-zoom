/**
 * angular-sofa-image-zoom - v0.1.0 - Mon Jan 12 2015 15:23:18 GMT+0100 (CET)
 * http://www.sofa.io
 *
 * Copyright (c) 2014 CouchCommerce GmbH (http://www.couchcommerce.com / http://www.sofa.io) and other contributors
 * THIS SOFTWARE CONTAINS COMPONENTS OF THE SOFA.IO COUCHCOMMERCE SDK (WWW.SOFA.IO)
 * IT IS PROVIDED UNDER THE LICENSE TERMS OF THE ATTACHED LICENSE.TXT.
 */
!function(o){o.module("sofa.imageZoom",["sofa-image-zoom.tpl.html"]),o.module("sofa-image-zoom.tpl.html",[]).run(["$templateCache",function(o){o.put("sofa-image-zoom.tpl.html",'<div class="sofa-image-zoom" ng-class="{\'sofa-image-zoom--active\': active}">\n    <img class="sofa-image-zoom__image" ng-src="{{imageSrc}}">\n</div>')}]),o.module("sofa.imageZoom").directive("sofaImageZoom",["$window","$compile","$rootScope","$timeout","sofaImageZoomService",function(e,t,n,i,a){"use strict";if(!o.isFunction(e.Hammer))throw new Error("Hammer.js is missing");return{restrict:"A",templateUrl:"sofa-image-zoom.tpl.html",compile:function(m){var s=n.$new();s.imageSrc="",s.closeZoomView=function(){s.active=!1,s.imageSrc="",s.$digest(),e.removeEventListener("resize",a.adjust)},s.openZoomView=function(o,t){s.imageSrc=o,s.active=!0,s.$digest(),e.addEventListener("resize",a.adjust),a.setup(t,s.$zoomImage[0],s.$zoomContainer[0])},s.$zoomContainer=t(m.contents())(s),s.$zoomImage=s.$zoomContainer.find("img"),o.element(e.document.body).prepend(s.$zoomContainer);var r=new Hammer.Manager(s.$zoomImage[0]),c=new Hammer.Pinch,l=new Hammer.Pan,u=new Hammer.Tap({event:"doubletap",taps:2,posThreshold:20});c.recognizeWith(l);var g=!1;return r.add([c,l,u]),r.on("pinchin pinchout",function(o){g||a.zoom(o,s.$zoomImage[0])}).on("pinchstart",function(){g=!1}).on("pinchend",function(o){g=!0,a.zoom(o,s.$zoomImage[0],!0),a.getZoomFactor()<=1&&s.closeZoomView()}).on("pan panend",function(o){a.move(o,s.$zoomImage[0],"panend"===o.type)}).on("doubletap",function(){a.getZoomFactor()>1?s.closeZoomView():a.setZoom(s.$zoomImage[0],1.5)}),s.imageScopes={},s.$watchCollection("imageScopes",function(o){Object.keys(o).length||(s.$zoomContainer.remove(),i(function(){s.$destroy()},0))}),function(e,t,n){var i=function(){return n.sofaImageZoom?e.$eval(n.sofaImageZoom):n.src};if(e.imageSrc=i(),!e.imageSrc)var m=e.$watch(function(){return i()},function(t){t&&o.isString(t)&&(e.imageSrc=t,m())});var r=function(){e.imageSrc&&s.openZoomView(e.imageSrc,t[0])},c=new Hammer.Manager(t[0]),l=new Hammer.Pinch,u=new Hammer.Tap({event:"doubletap",taps:2,posThreshold:20}),g=!1;c.add([l,u]),c.on("pinchstart",function(){g=!1}).on("pinchin pinchout",function(o){g||(s.active||"pinchout"!==o.type||r(),a.zoom(o,s.$zoomImage[0]))}).on("doubletap",function(){s.active||(r(),a.setZoom(s.$zoomImage[0],1.5,!0))}).on("pinchend",function(o){g=!0,a.zoom(o,s.$zoomImage[0],!0),a.getZoomFactor()<=1&&s.closeZoomView()}),s.imageScopes[e.$id]=e,e.$on("$destroy",function(){delete s.imageScopes[e.$id]})}}}}]),o.module("sofa.imageZoom").factory("sofaImageZoomService",function(){"use strict";var o="transform";["webkit","Moz","O","ms"].every(function(e){var t=e+"Transform";return void 0!==document.body.style[t]?(o=t,!1):!0});var e=/scale\([-+]?[0-9]*\.?[0-9]*\)/,t=/translate\((-?[0-9]*\.?[0-9]*?px), ?(-?[0-9]*\.?[0-9]*?px)\)/,n={};n.zoomFactor=1,n.movePosition={x:0,y:0},n.basePosition={x:0,y:0,w:0,h:0},n.containerDimensions={w:0,h:0},n.elements=null,n.maxScale=3;var i=this;return i.minScale=1,i.getElements=function(){return n.elements},i.getZoomFactor=function(){return n.zoomFactor},i.getBasePosition=function(){return n.basePosition},i.getContainerDimensions=function(){return n.containerDimensions},i.getLimits=function(){return n.limits},i.getMaxScale=function(){return n.maxScale},i.setElements=function(o,e,t){n.elements={originalElement:o,zoomElement:e,container:t}},i.setZoomFactor=function(o){i.resetLimits(),n.zoomFactor=o},i.setBasePosition=function(o){n.basePosition={x:o.left,y:o.top,w:o.width,h:o.height}},i.setContainerDimensions=function(o){n.containerDimensions={w:o.width,h:o.height}},i.setMovePosition=function(o,e){n.movePosition={x:o,y:e}},i.setLimits=function(o){n.limits=o},i.setMaxScale=function(o){n.maxScale=o&&o>3?o:3},i.resetZoomFactor=function(){i.setZoomFactor(1)},i.resetMovePosition=function(){i.setMovePosition(0,0)},i.resetElementStyles=function(e){e.style[o]=""},i.resetLimits=function(){n.limits=null},i.setZoom=function(t,n,a){var m="scale("+n+")",s=t.style[o].search(/scale/)>-1;t.style[o]=s?t.style[o].replace(e,m):t.style[o]+" "+m,a&&i.setZoomFactor(n)},i.zoom=function(o,e,t){var n=o.scale*i.getZoomFactor(),a=i.getMaxScale();n<i.minScale?n=i.minScale:n>a&&(n=a),i.setZoom(e,n,t)},i.checkLimits=function(){if(n.limits)return n.limits;var o,e,t,a,m,s=i.getZoomFactor(),r=i.getBasePosition(),c=i.getContainerDimensions(),l=s*r.w,u=s*r.h,g=c.w,f=c.h;return g>=l?(e=(g-l)/-2,t=(g-l)/2):(e=(l-g)/-2,t=(l-g)/2),f>=u?(a=(f-u)/-2,m=(f-u)/2):(a=(u-f)/-2,m=(u-f)/2),o=n.limits={left:parseInt(e/s,10),right:parseInt(t/s,10),top:parseInt(a/s,10),bottom:parseInt(m/s,10)}},i.shouldMove=function(){var o=n.containerDimensions.w-n.basePosition.w*n.zoomFactor<0,e=n.containerDimensions.h-n.basePosition.h*n.zoomFactor<0;return o||e},i.move=function(e,a,m){var s=parseInt(e.deltaX/n.zoomFactor+n.movePosition.x,10),r=parseInt(e.deltaY/n.zoomFactor+n.movePosition.y,10);if(i.shouldMove()){var c=i.checkLimits();s<c.left?s=c.left:s>c.right&&(s=c.right),r<c.top?r=c.top:r>c.bottom&&(r=c.bottom);var l=a.style[o].search(/translate/)>-1,u="translate("+s+"px, "+r+"px)";a.style[o]=l?a.style[o].replace(t,u):a.style[o]+" "+u,m&&i.setMovePosition(s,r)}},i.setup=function(o,e,t,n){i.resetZoomFactor(),i.resetMovePosition(),i.resetLimits(),i.resetElementStyles(e);var a=o.getBoundingClientRect();["left","top","width","height"].forEach(function(o){e.style[o]=a[o]+"px"}),n&&(a=o.getBoundingClientRect(),["left","top","width","height"].forEach(function(o){e.style[o]=a[o]+"px"})),i.setElements(o,e,t),i.setBasePosition(a),i.setMaxScale(e.naturalWidth/a.width),i.setContainerDimensions(t.getBoundingClientRect())},i.adjust=function(){var o=i.getElements(),e=i.getZoomFactor();o&&(i.setup(o.originalElement,o.zoomElement,o.container,!0),i.setZoom(o.zoomElement,e),i.setZoomFactor(e))},i})}(angular);